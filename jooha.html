<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>시그 검색기</title>
   <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #fff0f6; /* 연핑크 */
            color: #d6336c;      /* 진한 핑크 */
            padding: 2rem;
            min-height: 100vh
        }
        
        .main-wrapper {
            max-width: 70rem;
            margin: auto;
            background: #fff; /* 화이트 */
            border-radius: 1rem;
            padding: 2.5rem;
            box-shadow: 0 1rem 3rem rgba(214, 51, 108, 0.08)
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2rem;
            font-weight: 300;
            letter-spacing: 2px;
            color: #d6336c; /* 진한 핑크 */
        }
        
        .finder-panel {
            background: #ffe0ef; /* 연핑크 */
            padding: 1.5rem;
            border-radius: .5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #ffb3c6
        }
        
        .search-group {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap
        }
        
        .input-field {
            flex: 1;
            min-width: 20rem;
            padding: .75rem 1rem;
            background: #fff0f6;
            border: 2px solid #ffb3c6;
            border-radius: .5rem;
            color: #d6336c;
            font-size: 1rem
        }
        
        .input-field:focus {
            outline: none;
            border-color: #d6336c;
            box-shadow: 0 0 10px rgba(214, 51, 108, .15)
        }
        
        .btn {
            padding: .75rem 1.5rem;
            border: none;
            border-radius: .5rem;
            cursor: pointer;
            font-weight: 500;
            transition: all .2s
        }
        
        .btn-secondary {
            background: #ffb3c6;
            color: #fff
        }
        
        .btn-secondary:hover {
            background: #d6336c
        }
        
        .info-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            font-size: .9rem;
            color: #d6336c;
            gap: 1rem;
            flex-wrap: wrap
        }
        
        .data-grid {
            background: #fff0f6;
            border-radius: .5rem;
            overflow: hidden;
            box-shadow: 0 .5rem 1rem rgba(214, 51, 108, .08);
            max-height: 400px;
            overflow-y: auto
        }
        
        .grid-header {
            background: #ffe0ef;
            display: grid;
            grid-template-columns: 80px 1fr;
            padding: 1rem;
            font-weight: 600;
            border-bottom: 1px solid #ffb3c6;
            position: sticky;
            top: 0;
            z-index: 10;
            color: #d6336c;
        }
        
        .grid-row {
            display: grid;
            grid-template-columns: 80px 1fr;
            padding: .75rem 1rem;
            border-bottom: 1px solid #ffb3c6;
            transition: background .2s;
            background: #fff;
        }
        
        .grid-row:hover {
            background: #ffe0ef
        }
        
        .grid-row:last-child {
            border-bottom: none
        }
        
        .number-cell {
            text-align: center;
            font-weight: 600;
            color: #d6336c
        }
        
        .title-cell {
            font-size: .95rem
        }
        
        .match-highlight {
            background: #ffd6e0;
            color: #d6336c;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 600
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #ffb3c6;
            font-size: 1.1rem
        }
        
        .empty-state::before {
            content: "♪";
            display: block;
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #ffb3c6;
        }
        /* 스크롤바 스타일링 */
        
        .data-grid::-webkit-scrollbar {
            width: 8px
        }
        
        .data-grid::-webkit-scrollbar-track {
            background: #ffe0ef;
            border-radius: 4px
        }
        
        .data-grid::-webkit-scrollbar-thumb {
            background: #ffb3c6;
            border-radius: 4px
        }
        
        .data-grid::-webkit-scrollbar-thumb:hover {
            background: #d6336c
        }
        
        @media (max-width:560px) {
            .grid-header,
            .grid-row {
                grid-template-columns: 60px 1fr
            }
        }

        /* 모바일 인앱 브라우저 대응: 검색창/여백 축소 및 자동확대 방지 */
        html, body { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
        @media (max-width:560px) {
            body { padding: 1rem; }
            .main-wrapper { padding: 1rem; }
            .header { font-size: 1.5rem; margin-bottom: 1rem; }
            .finder-panel { padding: 1rem; }
            .search-group { gap: .5rem; }
            .input-field {
                min-width: 0;
                width: 100%;
                padding: .6rem .75rem;
                font-size: 16px; /* iOS 인앱 확대 방지 */
            }
            .btn { padding: .6rem 1rem; }
            .grid-header { padding: .75rem; }
            .grid-row { padding: .6rem .75rem; }
        }
        @media (max-width:360px) {
            body { padding: .75rem; }
            .main-wrapper { padding: .75rem; }
            .input-field { padding: .55rem .7rem; }
        }
    </style>
</head>

<body>
    <div class="main-wrapper">
          <div class="main-wrapper">
            <div style="text-align:center; margin-bottom:1.5rem;">
                <img src="logo.png" alt="로고" style="height:60px;" />
            </div>
        <h1 class="header">시그 검색기</h1>

        <div class="finder-panel">
            <div class="search-group">
                <input type="text" class="input-field" id="queryInput" placeholder="입력하는 즉시 검색됩니다 (제목 또는 갯수)" aria-label="곡 제목 또는 갯수 검색" autocomplete="off" />
            </div>
        </div>

        <div class="info-bar">
            <span id="resultCount" aria-live="polite">총 0개의 곡이 있습니다.</span>
            <span id="queryInfo" aria-live="polite"></span>
        </div>

        <div class="data-grid" id="musicGrid" role="region" aria-label="검색 결과">
            <div class="grid-header" role="row">
                <div>갯수</div>
                <div>곡 제목</div>
            </div>
            <div id="gridContent"></div>
        </div>

        <div id="emptyMessage" class="empty-state" style="display:none">검색된 곡이 없습니다</div>
    </div>

    <script>
        class MusicFinder {
            constructor() {
                this.musicData = [];
                this.currentResults = [];
                this.debouncedSearch = this.debounce(() => this.performSearch(), 250);
                this.collator = new Intl.Collator('ko', {
                    sensitivity: 'base',
                    usage: 'search'
                });
                this.init();
            }

            async init() {
                await this.loadMusicData();
                this.setupEvents();
                const lastQuery = localStorage.getItem('mf:lastQuery') || '';
                const input = document.getElementById('queryInput');
                if (lastQuery) input.value = lastQuery;
                this.performSearch();
                this.focusSearchInput();
            }

            async loadMusicData() {
                try {
                    const response = await fetch('./list.json', { cache: 'no-cache' });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    if (!Array.isArray(data)) throw new Error('list.json 형식 오류');
                    this.musicData = data;
                    this.currentResults = [...this.musicData];
                    return;
                } catch (error) {
                    console.warn('list.json 로드 실패, 내장 데이터로 계속합니다:', error);
                
               
                };
                this.currentResults = [...this.musicData];
            }

            setupEvents() {
                const input = document.getElementById('queryInput');

                input.addEventListener('input', this.debouncedSearch);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') this.clearSearch();
                });
            }
            performSearch() {
                const query = document.getElementById('queryInput').value.trim();
                localStorage.setItem('mf:lastQuery', query);

                if (!query) {
                    this.currentResults = [...this.musicData];
                    this.updateQueryInfo('');
                    this.renderResults('');
                    return;
                }

                const isNumericQuery = /^\d+$/.test(query);

                this.currentResults = this.musicData.filter((track) => {
                    if (isNumericQuery) {
                        // 숫자(갯수) 검색: 부분일치
                        return String(track.id).includes(query);
                    } else {
                        // 텍스트/별명 검색
                        const inTitle = this.includesSafe(track.title, query);
                        const inAlias =
                            Array.isArray(track.alias) &&
                            track.alias.some(a => this.includesSafe(a, query));
                        return inTitle || inAlias;
                    }
                });

                const searchType = isNumericQuery ? '갯수' : '텍스트/별명';
                this.updateQueryInfo(`"${query}" ${searchType} 검색`);
                this.renderResults(query);
            }

            clearSearch() {
                const input = document.getElementById('queryInput');
                input.value = '';
                localStorage.removeItem('mf:lastQuery');
                this.updateQueryInfo('');
                this.currentResults = [...this.musicData];
                this.renderResults('');
                this.focusSearchInput();
            }

            updateQueryInfo(msg) {
                document.getElementById('queryInfo').textContent = msg;
            }

            renderResults(highlightTerm = '') {
                const gridContent = document.getElementById('gridContent');
                const musicGrid = document.getElementById('musicGrid');
                const emptyMessage = document.getElementById('emptyMessage');
                const resultCount = document.getElementById('resultCount');

                resultCount.textContent = `총 ${this.currentResults.length}개의 곡이 있습니다.`;
                gridContent.innerHTML = '';

                if (this.currentResults.length === 0) {
                    musicGrid.style.display = 'none';
                    emptyMessage.style.display = 'block';
                    return;
                }

                musicGrid.style.display = 'block';
                emptyMessage.style.display = 'none';

                const frag = document.createDocumentFragment();
                const isNum = /^\d+$/.test(highlightTerm);
                const qNum = isNum ? parseInt(highlightTerm, 10) : null;

                this.currentResults.forEach((track) => {
                    const row = document.createElement('div');
                    row.className = 'grid-row';
                    row.setAttribute('role', 'row');

                    const numCell = document.createElement('div');
                    numCell.className = 'number-cell';
                    numCell.setAttribute('role', 'cell');

                    const titleCell = document.createElement('div');
                    titleCell.className = 'title-cell';
                    titleCell.setAttribute('role', 'cell');

                    // 갯수 하이라이트 (부분 일치 기준)
                    if (isNum && String(track.id).includes(highlightTerm)) {
                        this.applySafeHighlight(numCell, String(track.id), highlightTerm);
                    } else {
                        numCell.textContent = String(track.id);
                    }

                    // 제목 하이라이트 (안전 처리)
                    if (!isNum && highlightTerm) {
                        this.applySafeHighlight(titleCell, track.title, highlightTerm);
                    } else {
                        titleCell.textContent = track.title;
                    }

                    row.appendChild(numCell);
                    row.appendChild(titleCell);
                    frag.appendChild(row);
                });

                gridContent.appendChild(frag);
            }

            // 문자열 포함 여부 (한글/대소문자 구분 완화)
            includesSafe(text, query) {
                if (typeof text !== 'string') return false;
                return text.toLowerCase().includes(query.toLowerCase()) ||
                    this.collator.compare(text, query) === 0;
            }

            // 안전한 하이라이트: 텍스트 노드를 분할하여 span 삽입
            applySafeHighlight(container, text, term) {
                const lower = String(text).toLowerCase();
                const t = String(term).toLowerCase();
                let start = 0;
                let idx = lower.indexOf(t);

                while (idx !== -1) {
                    if (idx > start) {
                        container.appendChild(document.createTextNode(text.slice(start, idx)));
                    }
                    const mark = document.createElement('span');
                    mark.className = 'match-highlight';
                    mark.textContent = text.slice(idx, idx + t.length);
                    container.appendChild(mark);

                    start = idx + t.length;
                    idx = lower.indexOf(t, start);
                }
                if (start < text.length) {
                    container.appendChild(document.createTextNode(text.slice(start)));
                }
            }

            // 디바운스 유틸
            debounce(fn, delay = 250) {
                let timer = null;
                return (...args) => {
                    clearTimeout(timer);
                    timer = setTimeout(() => fn.apply(this, args), delay);
                };
            }

            focusSearchInput() {
                document.getElementById('queryInput').focus();
            }
        }

        document.addEventListener('DOMContentLoaded', () => new MusicFinder());
    </script>
</body>

</html>
